<!DOCTYPE html>
<html lang="en">
<head>
    <title>Loading...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        
        /* লোডিং স্ক্রিন */
        #loading { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* রিপোর্ট বাটন স্টাইল */
        #reportWrapper { position: fixed; bottom: 15px; right: 15px; z-index: 10000; }
        .report-btn { background: rgba(255,255,255,0.9); border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; color: #555; font-size: 12px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; transition: 0.3s; }
        .report-btn:hover { background: #fee2e2; color: #dc2626; border-color: #dc2626; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading Website...</p>
    </div>

    <!-- রিপোর্ট বাটনটি আলাদা ডিভ-এ রাখা হলো -->
    <div id="reportWrapper" style="display:none;">
        <button class="report-btn" onclick="reportSite()">
            <i class="fa-solid fa-flag"></i> Report Abuse
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD-fR5yCte_c2pHpd0WD5IVjWmUvfUl5wA",
            authDomain: "html-code-hosting.firebaseapp.com",
            projectId: "html-code-hosting",
            storageBucket: "html-code-hosting.firebasestorage.app",
            messagingSenderId: "22191194064",
            appId: "1:22191194064:web:47fcd0b42f0f770ede43d5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const params = new URLSearchParams(window.location.search);
        const siteId = params.get('id');

        if(siteId) {
            const docRef = db.collection('sites').doc(siteId);
            
            docRef.get().then(doc => {
                const loading = document.getElementById('loading');
                
                if(doc.exists && doc.data().status === 'active') {
                    // ১. HTML লোড করা
                    document.open();
                    document.write(doc.data().html);
                    document.close();

                    // ২. রিপোর্ট বাটনটি আবার বডিতে যুক্ত করা (কারণ document.write সব মুছে দেয়)
                    const btnHTML = `
                        <div style="position:fixed; bottom:15px; right:15px; z-index:9999;">
                            <button onclick="window.triggerReport()" style="background:rgba(255,255,255,0.9); border:1px solid #ccc; padding:8px 15px; border-radius:20px; color:#555; font-size:12px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2); font-weight:bold;">
                                ⚠️ Report Abuse
                            </button>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', btnHTML);

                    // ৩. ভিউ কাউন্টার ১ বাড়ানো
                    docRef.update({ views: firebase.firestore.FieldValue.increment(1) });

                } else {
                    loading.innerHTML = "<h2 style='color:red'>⛔ Site Not Found</h2>";
                }
            }).catch(e => {
                document.getElementById('loading').innerHTML = "<h2>Error Loading</h2>";
                console.error(e);
            });
        }

        // গ্লোবাল রিপোর্ট ফাংশন
        window.triggerReport = function() {
            if(!siteId) return;
            if(confirm("আপনি কি নিশ্চিত এই সাইটটি ক্ষতিকর হিসেবে রিপোর্ট করতে চান?")) {
                const dbInst = firebase.firestore();
                dbInst.collection('sites').doc(siteId).update({
                    reportCount: firebase.firestore.FieldValue.increment(1)
                }).then(() => {
                    alert("ধন্যবাদ! আমরা সাইটটি রিভিউ করব।");
                }).catch((err) => {
                    alert("রিপোর্ট করা যায়নি! কারণ: " + err.message);
                });
            }
        }
    </script>
</body>
</html>
