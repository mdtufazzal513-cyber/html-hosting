<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Publisher - User</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; padding: 20px; color: #334155; }
        
        /* Auth Styles */
        #authContainer { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; background: #4f46e5; color: white; margin-top: 10px; }
        button:disabled { background: #9ca3af; }
        .link { color: #4f46e5; cursor: pointer; text-decoration: underline; margin-top: 15px; display: block; font-size: 0.9rem; }

        /* Dashboard Styles */
        #dashboard { display: none; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; background: #1e293b; color: #fff; font-family: monospace; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 1; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <!-- AUTH SECTION -->
    <div id="authContainer">
        <!-- Login Form -->
        <div id="loginForm">
            <h2>üîê Login</h2>
            <input type="email" id="lEmail" placeholder="Email (@gmail.com)">
            <input type="password" id="lPass" placeholder="Password">
            <button onclick="login()">Login</button>
            <span class="link" onclick="showSignup()">Create New Account</span>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" style="display:none;">
            <h2>üìù Sign Up</h2>
            <input type="text" id="rName" placeholder="Full Name">
            <input type="text" id="rUser" placeholder="Username">
            <input type="email" id="rEmail" placeholder="Email (@gmail.com)">
            <input type="password" id="rPass" placeholder="Password (Min 6 chars)">
            <input type="password" id="rPassConf" placeholder="Confirm Password">
            <button onclick="signup()">Create Account</button>
            <span class="link" onclick="showLogin()">Back to Login</span>
        </div>

        <!-- Verify Email Msg -->
        <div id="verifyMsg" style="display:none;">
            <h2 style="color:#eab308;">‚ö†Ô∏è Email Verification</h2>
            <p>We sent a verification link to your email. Please check your inbox/spam folder.</p>
            <button onclick="location.reload()">I have Verified!</button>
            <span class="link" onclick="firebase.auth().signOut()">Logout</span>
        </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="welcomeText">Welcome</h2>
            <button onclick="firebase.auth().signOut()" style="width:auto; background:#ef4444; padding:8px 15px;">Logout</button>
        </div>

        <div class="card">
            <label><b>HTML Code Editor</b></label>
            <textarea id="code" placeholder="<html>...</html>"></textarea>
            
            <div style="margin-top:15px; display:flex; gap:10px;">
                <input type="text" id="siteName" placeholder="Custom Link Name (Optional)">
                <input type="text" id="pin" placeholder="Set PIN (For security)">
            </div>

            <button onclick="publish()" id="pubBtn">üöÄ Publish Site</button>
        </div>

        <!-- Result -->
        <div id="result" class="card" style="margin-top:20px; display:none; background:#f0fdf4; border:1px solid #86efac;">
            <h3 style="color:#166534; margin-top:0;">Published Successfully!</h3>
            <a id="finalLink" href="#" target="_blank" style="color:#15803d; font-weight:bold; word-break:break-all;">...</a>
        </div>
    </div>

    <div id="toast">Message</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD-fR5yCte_c2pHpd0WD5IVjWmUvfUl5wA",
            authDomain: "html-code-hosting.firebaseapp.com",
            projectId: "html-code-hosting",
            storageBucket: "html-code-hosting.firebasestorage.app",
            messagingSenderId: "22191194064",
            appId: "1:22191194064:web:47fcd0b42f0f770ede43d5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH STATE LISTENER ---
        auth.onAuthStateChanged(user => {
            const authDiv = document.getElementById('authContainer');
            const dashDiv = document.getElementById('dashboard');
            const loginF = document.getElementById('loginForm');
            const verifyF = document.getElementById('verifyMsg');

            if(user) {
                if(user.emailVerified) {
                    authDiv.style.display = 'none';
                    dashDiv.style.display = 'block';
                    document.getElementById('welcomeText').innerText = "Hello, " + (user.displayName || "User");
                } else {
                    authDiv.style.display = 'block';
                    dashDiv.style.display = 'none';
                    loginF.style.display = 'none';
                    verifyF.style.display = 'block';
                }
            } else {
                authDiv.style.display = 'block';
                dashDiv.style.display = 'none';
                loginF.style.display = 'block';
                verifyF.style.display = 'none';
                document.getElementById('signupForm').style.display = 'none';
            }
        });

        // --- AUTH FUNCTIONS ---
        function showSignup() { document.getElementById('loginForm').style.display='none'; document.getElementById('signupForm').style.display='block'; }
        function showLogin() { document.getElementById('signupForm').style.display='none'; document.getElementById('loginForm').style.display='block'; }
        function toast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.className="show"; setTimeout(()=>t.className="", 3000); }

        function signup() {
            const email = document.getElementById('rEmail').value;
            const pass = document.getElementById('rPass').value;
            const conf = document.getElementById('rPassConf').value;
            const name = document.getElementById('rName').value;

            if(!email.endsWith('@gmail.com')) return toast("Only @gmail.com allowed!");
            if(pass !== conf) return toast("Passwords do not match!");
            if(pass.length < 6) return toast("Password too short!");

            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                cred.user.updateProfile({ displayName: name });
                cred.user.sendEmailVerification();
                
                // Save User Data
                db.collection('users').doc(cred.user.uid).set({
                    name: name, email: email, uid: cred.user.uid, createdAt: new Date()
                });
                alert("Verification email sent! Check your inbox.");
            }).catch(e => toast(e.message));
        }

        function login() {
            const email = document.getElementById('lEmail').value;
            const pass = document.getElementById('lPass').value;
            if(!email || !pass) return toast("Fill all fields");
            auth.signInWithEmailAndPassword(email, pass).catch(e => toast(e.message));
        }

        // --- PUBLISH LOGIC ---
        async function publish() {
            const html = document.getElementById('code').value;
            const custom = document.getElementById('siteName').value.trim();
            const pin = document.getElementById('pin').value;
            const btn = document.getElementById('pubBtn');

            if(!html || !pin) return toast("HTML Code and PIN required!");

            btn.innerText = "Publishing...";
            btn.disabled = true;

            const siteId = custom || Math.random().toString(36).substring(2, 12);
            const docRef = db.collection('sites').doc(siteId);

            try {
                const doc = await docRef.get();
                if(doc.exists) throw new Error("This link name is already taken!");

                await docRef.set({
                    html: html,
                    pin: pin,
                    author: auth.currentUser.uid,
                    views: 0,
                    reportCount: 0,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const url = window.location.origin + window.location.pathname.replace('index.html', '') + 'view.html?id=' + siteId;
                document.getElementById('finalLink').href = url;
                document.getElementById('finalLink').innerText = url;
                document.getElementById('result').style.display = 'block';

            } catch (e) {
                toast(e.message);
            }
            btn.innerText = "üöÄ Publish Site";
            btn.disabled = false;
        }
    </script>
</body>
</html>
